---
title: "p8105_hw3_sy3352"
author: "Su Yan"
date: "2025-10-06"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(p8105.datasets)
library(patchwork)
library(janitor)
library(knitr)
data("instacart")
```

# Problem 1

The `instacart` data set contains data of order details people placed on instacart in 2017. It contains `r nrow(instacart)` observations and `r ncol(instacart)` columns. Each row gives detailed information of one product in an order. Some of the key variables are `order_id` `product_id` `reordered` `order_dow` `order_hour_of_day` `product_name` `aisle` and `department`. For example, row 3859 displayed an **Organic Baby Carrots**
 ordered by userid **198041** on Saturday afternoon (`order_dow`: 6 and `order_hour_of_day`: 18), which belongs to aisle **packaged vegetables fruits** and department **produce**.

```{r}
aisle_amount = count(instacart, aisle, sort = TRUE)
aisle_amount
```
There are `r nrow(distinct(instacart,aisle))` aisles. The most ordered aisles are `fresh vegetables`, `fresh fruits`, `packaged vegetables fruits`, `yogurt` and `packaged cheese`.

```{r}
aisle_amount = filter(aisle_amount, n>10000) 
aisle_amount |> 
  ggplot(aes(x = reorder(aisle,n), y = n)) + 
  geom_col() +
  coord_flip(ylim = c(10000, NA)) + 
  scale_y_continuous(breaks = c(10000, 40000, 80000, 120000)) +
  labs(title = "Number of items ordered in each aisle (# > 10000)",
       x = "aisle",
       y = "number of items ordered")
```

Most Popular Items in Selected Aisles:
```{r}
top_3_aisle = filter(instacart, aisle == c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  select(aisle, product_name) |> 
  group_by(aisle, product_name) |> 
  summarize(number_items_ordered = n()) |> 
  group_by(aisle) |> 
  slice_max(number_items_ordered, n = 3) |> 
  knitr::kable(digits = 0) 
top_3_aisle
```

The mean hour of the day at which the selected two products are ordered:
```{r}
product_week_hour = filter(instacart, product_name == c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  select(order_dow, product_name, order_hour_of_day) |> 
  pivot_wider(names_from = order_dow,
              values_from = order_hour_of_day,
              names_prefix = "day_",
              values_fn = mean) |> 
  rename(Sunday = "day_0", Monday = "day_1", Tuesday = "day_2", Wednesday = "day_3",
         Thursday = "day_4", Friday = "day_5", Saturday = "day_6") |> 
  select(product_name, Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday) |> 
  knitr::kable(digits = 0)
product_week_hour
```

# Problem 2

```{r}
rent_df = read_csv("data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
  pivot_longer(cols = 10:125,
               names_to = "date",
               values_to = "rent_rate") |> 
  janitor::clean_names() |> 
  select(-region_type, -state_name, -state, -city, -metro, -region_id, -size_rank) |> 
  rename(zip_code = region_name)

zip_df = read_csv("data/Zip Codes.csv") |> 
  janitor::clean_names() |> 
  select(-county_code, -county_fips, -state_fips, -file_date, -county)

rent_neigh_joint_df = rent_df |> 
  left_join(zip_df, by = c("zip_code")) |> 
  relocate(last_col(), .after = 2) |> 
  drop_na(rent_rate)
```

```{r}
count_zip = rent_neigh_joint_df |> 
  group_by(zip_code) |> 
  summarize(month_count = n()) 
```

`r sum(count_zip$month_count == 116)` zip codes are observed 116 times. `r sum(count_zip$month_count < 10)` zip codes are observed less than 10 times. Possible reasons for some zip codes to be observed fewer than others can be that they are commercial zip codes or PO-box zip codes which does not represent residential significance and thus does not provide consistent rent information. For example, the zip code **10044** was observed 9 times. It stands for Roosevelt island which has a small area and thus less housing for rent, resulting in less rental information provided. 

```{r}
year_trend = rent_neigh_joint_df |> 
  mutate(year = year(date)) |> 
  select(-zip_code, -date, -neighborhood) |> 
  pivot_wider(names_from = year,
              values_from = rent_rate,
              names_prefix = "year_",
              values_fn = mean,
              names_sort = TRUE) |> 
  rename(borough = county_name) |> 
  knitr::kable(digits = 2)
year_trend
```
From the table above, we can see that in general, the rental prices across all boroughs in NYC increased consistently from year 2015 to year 2024, except in year 2022 when the impact of covid-19 caused on overall decline in rental pr1ices compared with the previous year. There were no rental data available for Richmond County until year 2020.  
Among the 5 boroughs that we compare, New York County consistently has the highest rental prices, and the Bronx County has the lowest.  
Bronx county experienced the fastest rent growth among the 5 boroughs with its rent in 2024 being **1.39** times higher compared to what's in 2015. In contrast, Queens has the slowest rent growth with a **1.22** times higher rent in 2024 compared with that in 2015.

```{r}
zip_year = rent_neigh_joint_df |> 
  mutate(year = year(date)) |> 
  select(-date) |> 
  group_by(county_name, zip_code, year) |> 
  summarize(yearly_rent = mean(rent_rate, na.rm = TRUE)) |> 
  rename(borough = county_name) 
```

```{r zip_year_plot, fig.width = 10, fig.height = 12}
zip_year_plot = 
  zip_year |> ggplot(aes(x=year, y = yearly_rent, color = borough)) + 
  geom_point(alpha = .5) + 
  facet_wrap(~borough, ncol = 1) +
  scale_x_continuous(breaks = 2015:2024) +
  labs(
    title = "Annual Rent of Each Zip Code by Borough",
    x = "Year",
    y = "Average Rent (USD)"
  ) +
  theme(strip.text = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "bottom")
zip_year_plot
```
The plot shows the annual rent price by zip code in NYC from 2015 to 2024. The 5 boroughs in the plot are represented by 5 different colors as shown in the legend at the bottom. Each point in the plot represents a zip code's rent in a certain year. From the plot we can see overall all 5 boroughs in NYC experience a steady growth (except for 2020-2021 due to covid-19 impact) in rent and also a more and more spread-out price range. Richmond County has no data available during 2015 to 2019, thus the points only starts from 2020. New York County has not only overall highest rent but also the widest range of rents, indicating the most diversity in housing rental options.

```{r}
zip_mon_2023 = rent_neigh_joint_df |> 
  mutate(date = as.Date(date),
         month = lubridate::month(date)) |> 
  filter(lubridate::year(date) == 2023) |> 
  select(-date, -neighborhood) |> 
  rename(borough = county_name) 
```

```{r zip_mon_2023_plot, fig.width = 10, fig.height = 8}
zip_mon_2023_plot = 
  zip_mon_2023 |> ggplot(aes(x = factor(month), y = rent_rate, fill = borough)) + 
  geom_violin(alpha = .5) +
  facet_wrap(~borough, ncol = 1) +
  labs(
    title = "Rent by Zip Codes by Borough in 2023",
    x = "Month (in 2023)",
    y = "Rent (USD)"
  ) +
  theme(strip.text = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "bottom")
zip_mon_2023_plot
```

The plot shows the rent price of each zip code in NYC by month of 2023. The 5 boroughs in the plot are represented by 5 different colors as shown in the legend at the bottom. Each violin in the plot represents the allocation of rental price of zip codes in each month. From the plot we can see overall all 5 boroughs in NYC has a stable retal price throughout the year, with a very slight steady growth towards the end of the year. New York County has not only overall highest rent but also the widest range of rents, indicating the most diversity in housing rental options. Bronx and Richmond County has relatively low rent but also the most tightly clustered rent distribution, indicating that housing options in these boroughs are relatively uniformed.

```{r}
ggsave(filename = "results/zillow_rent_combined_plot.png",
       plot = zip_year_plot / zip_mon_2023_plot,
       width = 10,
       height = 20,
       dpi = 600)
```

# Problem 3

```{r}
covar_df = read_csv("data/nhanes_covar.csv",skip = 4) |> 
  janitor::clean_names() |> 
  filter(!(bmi == "na"), !(education == "na"), age >= 21) |> 
  mutate(sex = factor(sex), education = factor(education)) |> 
  mutate(sex = recode(sex, `1` = "male", `2` = "female"),
         education = recode(education, `1` = "less than high school",
                            `2` = "high school equivalent",
                            `3` = "more than high school")) 
```

```{r}
accel_df = read_csv("data/nhanes_accel.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "mims"
  )

joint_mims = accel_df |> 
  left_join(covar_df, by = c("seqn")) |> 
  filter(!(bmi == "na"), !(education == "na")) 
```

```{r}
edu_gender = 
  covar_df |> select(-seqn, -age, -bmi) |> 
  group_by(education, sex) |> 
  summarize(n = n()) |> 
  pivot_wider(names_from = sex, values_from = n) |> 
  knitr::kable()
edu_gender
```

**The figure above shows the**

```{r age_edu_plot, fig.width = 8, fig.height = 8}
age_edu_plot = 
  covar_df |> 
  ggplot(aes(x = factor(education), y = age, color = sex)) + 
  geom_violin(alpha = .5) + 
  facet_wrap(~sex, ncol = 1) +
  labs(
    title = "Age Distribution for Men and Women in Each Education Category",
    x = "Education Category",
    y = "Age"
  ) +
  theme(strip.text = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "bottom")
age_edu_plot
```

**The figure above shows the**

```{r}
total_activity = joint_mims |> 
  group_by(seqn, sex, age, education) |> 
  summarize(total_activity = sum(mims, na.rm = TRUE)) 
total_activity_plot = total_activity |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  geom_point(alpha = .7) + 
  geom_smooth(se = FALSE) + 
  facet_wrap(~education) +
  labs(
    title = "Total Activity against Age in Different Education Groups",
    x = "Age",
    y = "Total Activity (from MIMS readings)"
  ) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "bottom")
total_activity_plot 
```

**The figure above shows the**

